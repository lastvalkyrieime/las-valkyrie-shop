require('dotenv').config(); // TAMBAHKAN INI DI BARIS PALING ATAS
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');

const app = express();

// CORS configuration
app.use(cors({
    origin: '*',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Accept']
}));

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// MongoDB Connection - Gunakan environment variable
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb+srv://lastvalkyrieime_db_user:lvime2025@lvresourcedatabase.9wth93k.mongodb.net/las_valkyrie?retryWrites=true&w=majority';

console.log('ğŸ”§ Initializing MongoDB connection...');
console.log('ğŸ“ Database: las_valkyrie');
console.log('ğŸ”— Connection string:', MONGODB_URI ? 'Loaded from environment' : 'Using default');

const connectDB = async () => {
    try {
        await mongoose.connect(MONGODB_URI, {
            useNewUrlParser: true,
            useUnifiedTopology: true,
            serverSelectionTimeoutMS: 10000,
            socketTimeoutMS: 45000,
        });
        console.log('âœ… MongoDB Connected Successfully to las_valkyrie database');
        
        // Check if collections exist and create sample data if empty
        await initializeDatabase();
    } catch (error) {
        console.error('âŒ MongoDB Connection Error:', error.message);
        console.log('âš ï¸  Using fallback mode (in-memory storage)');
    }
};

// Function to initialize database with sample data
async function initializeDatabase() {
    try {
        const productCount = await Product.countDocuments();
        const orderCount = await Order.countDocuments();
        
        console.log(`ğŸ“Š Database stats - Products: ${productCount}, Orders: ${orderCount}`);
        
        // If no products, create sample data
        if (productCount === 0) {
            console.log('ğŸ“¦ Creating sample products...');
            const sampleProducts = [
                {
                    name: 'AK-47',
                    category: 'senjata',
                    price: 15000,
                    stock: 10,
                    description: 'Senjata assault rifle kualitas tinggi'
                },
                {
                    name: 'Body Armor', 
                    category: 'armor',
                    price: 8000,
                    stock: 15,
                    description: 'Pelindung tubuh level 3'
                },
                {
                    name: 'Ganja Premium',
                    category: 'ganja',
                    price: 5000,
                    stock: 20,
                    description: 'Ganja kualitas tinggi'
                }
            ];
            
            await Product.insertMany(sampleProducts);
            console.log('âœ… Sample products created');
        }
    } catch (error) {
        console.error('âŒ Error initializing database:', error.message);
    }
}

connectDB();

// MongoDB Schemas (tetap sama)
const productSchema = new mongoose.Schema({
    name: { type: String, required: true },
    category: { type: String, required: true },
    price: { type: Number, required: true },
    stock: { type: Number, required: true },
    description: { type: String, default: '' }
}, { timestamps: true });

const orderSchema = new mongoose.Schema({
    customerName: { type: String, required: true },
    discordId: { type: String, default: '' },
    additionalInfo: { type: String, default: '' },
    items: [{
        productId: String,
        name: String,
        price: Number,
        quantity: Number
    }],
    totalPrice: { type: Number, required: true },
    status: { type: String, default: 'pending' }
}, { timestamps: true });

const Product = mongoose.model('Product', productSchema);
const Order = mongoose.model('Order', orderSchema);

// Fallback data (tetap sama)
const fallbackProducts = [
    {
        _id: 'fallback_1',
        name: 'AK-47',
        category: 'senjata',
        price: 15000,
        stock: 10,
        description: 'Senjata assault rifle - FALLBACK MODE'
    },
    {
        _id: 'fallback_2',
        name: 'Body Armor', 
        category: 'armor',
        price: 8000,
        stock: 15,
        description: 'Pelindung tubuh level 3 - FALLBACK MODE'
    },
    {
        _id: 'fallback_3',
        name: 'Ganja Premium',
        category: 'ganja',
        price: 5000,
        stock: 20,
        description: 'Ganja kualitas tinggi - FALLBACK MODE'
    }
];

let fallbackOrders = [];

// Check MongoDB connection
function isMongoConnected() {
    return mongoose.connection.readyState === 1;
}

// ===== PRODUCT ROUTES =====
// Get all products - TAMBAH ERROR HANDLING LEBIH BAIK
app.get('/api/products', async (req, res) => {
    try {
        console.log('ğŸ“¦ GET /api/products called');
        
        if (isMongoConnected()) {
            const products = await Product.find().sort({ createdAt: -1 });
            console.log(`âœ… Found ${products.length} products in MongoDB`);
            
            return res.json({
                success: true,
                data: products,
                message: 'Products retrieved from MongoDB',
                source: 'mongodb',
                count: products.length
            });
        } else {
            console.log('âš ï¸  MongoDB not connected, using fallback data');
            return res.json({
                success: true,
                data: fallbackProducts,
                message: 'Products retrieved from fallback storage',
                source: 'fallback',
                count: fallbackProducts.length
            });
        }
    } catch (error) {
        console.error('âŒ Error in /api/products:', error.message);
        res.json({
            success: true,
            data: fallbackProducts,
            message: 'Products retrieved from fallback storage (error)',
            source: 'fallback',
            count: fallbackProducts.length
        });
    }
});

// Add new product - TAMBAH VALIDATION
app.post('/api/products', async (req, res) => {
    try {
        console.log('â• POST /api/products called:', req.body);
        
        const { name, category, price, stock, description } = req.body;
        
        // Validation
        if (!name || !category || !price || !stock) {
            return res.status(400).json({
                success: false,
                error: 'Missing required fields: name, category, price, stock'
            });
        }
        
        const productData = { name, category, price, stock, description };
        
        if (isMongoConnected()) {
            const newProduct = new Product(productData);
            const savedProduct = await newProduct.save();
            
            console.log('âœ… Product saved to MongoDB:', savedProduct._id);
            
            return res.json({
                success: true,
                message: 'Product created successfully in MongoDB',
                data: savedProduct,
                source: 'mongodb'
            });
        } else {
            // Add to fallback data
            const newProduct = {
                _id: 'prod_' + Date.now(),
                ...productData,
                createdAt: new Date().toISOString()
            };
            fallbackProducts.push(newProduct);
            
            console.log('âœ… Product saved to fallback storage');
            
            return res.json({
                success: true,
                message: 'Product created successfully in fallback storage',
                data: newProduct,
                source: 'fallback'
            });
        }
    } catch (error) {
        console.error('âŒ Error in POST /api/products:', error.message);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// DELETE, ORDER ROUTES, dan lainnya TETAP SAMA...
// [Kode untuk delete, orders, admin routes tetap sama seperti sebelumnya]

// Health check endpoint - TAMBAH INFO LEBIH DETAIL
app.get('/', (req, res) => {
    const dbStatus = isMongoConnected() ? 'connected' : 'disconnected';
    const dbName = mongoose.connection.name || 'las_valkyrie';
    
    res.json({
        success: true,
        message: 'Las Valkyrie API is running!',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'production',
        version: '2.0.0',
        database: {
            status: dbStatus,
            name: dbName,
            host: mongoose.connection.host || 'unknown'
        },
        endpoints: {
            products: '/api/products',
            orders: '/api/orders',
            admin: '/api/admin'
        }
    });
});

// Handle preflight requests
app.options('*', (req, res) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, Accept');
    res.status(200).send();
});

// Handle 404
app.use('*', (req, res) => {
    console.log('âŒ 404 Route not found:', req.originalUrl);
    res.status(404).json({
        success: false,
        error: 'Route not found: ' + req.originalUrl,
        availableEndpoints: [
            'GET /',
            'GET /api/products',
            'POST /api/products',
            'DELETE /api/products/:id',
            'GET /api/orders',
            'POST /api/orders',
            'PUT /api/orders/:id',
            'POST /api/admin/login'
        ]
    });
});

// Error handling middleware
app.use((error, req, res, next) => {
    console.error('ğŸš¨ Server Error:', error);
    res.status(500).json({
        success: false,
        error: 'Internal server error: ' + error.message
    });
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
    console.log(`ğŸš€ Server running on port ${PORT}`);
    console.log(`ğŸ“ Health check: http://localhost:${PORT}/`);
    console.log(`ğŸ“ MongoDB Status: ${isMongoConnected() ? 'Connected' : 'Disconnected'}`);
    console.log(`ğŸ“ Database: las_valkyrie`);
    console.log(`ğŸ“ Environment: ${process.env.NODE_ENV || 'production'}`);
});

module.exports = app;
