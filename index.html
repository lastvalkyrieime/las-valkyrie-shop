// =============================================
// KONFIGURASI BACKEND - PRODUCTION
// =============================================
const BACKEND_URL = 'https://las-valkyrie-backend.vercel.app';
const API_BASE_URL = `${BACKEND_URL}/api`;

// =============================================
// STATE APLIKASI
// =============================================
let products = [];
let cart = [];
let currentCategory = 'all';
let isBackendOnline = false;
let isAdminLoggedIn = false;

// =============================================
// FUNGSI BACKEND YANG DIPERBAIKI
// =============================================

// Cek koneksi backend
async function checkBackendConnection() {
    try {
        console.log('üîç Checking backend connection...');
        
        const response = await fetch(`${BACKEND_URL}/`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        console.log('üì° Backend response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            isBackendOnline = true;
            updateBackendStatus('‚úÖ Backend & MongoDB terhubung!', 'online');
            console.log('‚úÖ Backend connected successfully');
            return true;
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        isBackendOnline = false;
        console.error('‚ùå Backend connection failed:', error);
        updateBackendStatus('‚ùå Backend offline - menggunakan mode lokal', 'offline');
        return false;
    }
}

// Update status backend
function updateBackendStatus(message, status) {
    const statusElement = document.getElementById('backendStatus');
    statusElement.textContent = message;
    statusElement.className = `backend-status ${status}`;
}

// Load products dari BACKEND
async function loadProducts() {
    const productsContainer = document.getElementById('productsContainer');
    
    try {
        console.log('üîÑ Loading products from backend...');
        
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        console.log('üì¶ Products response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Products loaded successfully:', result);
        
        if (result.success) {
            products = result.data || [];
            console.log('üìä Products data from:', result.source, 'Count:', products.length);
            displayProducts();
            
            // Tampilkan info source
            if (result.source === 'mongodb') {
                showNotification('üì¶ Produk dimuat dari MongoDB', false);
            } else if (result.source === 'fallback') {
                showNotification('‚ö†Ô∏è Menggunakan data fallback', true);
            }
        } else {
            throw new Error(result.error || 'Gagal memuat produk dari backend');
        }
    } catch (error) {
        console.error('‚ùå Error loading products:', error);
        
        // Fallback ke data lokal
        products = getLocalProducts();
        displayProducts();
        
        productsContainer.innerHTML += `
            <div class="error-message">
                ‚ö†Ô∏è Menggunakan data lokal: ${error.message}
                <br>
                <button class="btn" onclick="loadProducts()" style="margin-top: 10px;">üîÑ Coba Lagi</button>
            </div>
        `;
    }
}

// Fungsi fallback data lokal
function getLocalProducts() {
    return [
        {
            _id: 'local-1',
            name: 'AK-47 (Local)',
            category: 'senjata',
            price: 15000,
            stock: 10,
            description: 'Senjata assault rifle - MODE LOKAL'
        },
        {
            _id: 'local-2',
            name: 'Body Armor (Local)', 
            category: 'armor',
            price: 8000,
            stock: 15,
            description: 'Pelindung tubuh level 3 - MODE LOKAL'
        },
        {
            _id: 'local-3',
            name: 'Ganja Premium (Local)',
            category: 'ganja',
            price: 5000,
            stock: 20,
            description: 'Ganja kualitas tinggi - MODE LOKAL'
        }
    ];
}

// =============================================
// FUNGSI ADMIN - SELALU GUNAKAN BACKEND
// =============================================

// Tambah produk baru - SELALU KIRIM KE BACKEND
async function addProduct(event) {
    event.preventDefault();
    
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').value;
    const price = parseInt(document.getElementById('productPrice').value);
    const stock = parseInt(document.getElementById('productStock').value);
    const description = document.getElementById('productDescription').value;
    
    const productData = {
        name: name,
        category: category,
        price: price,
        stock: stock,
        description: description
    };
    
    try {
        console.log('üì§ Adding product to backend:', productData);
        
        // SELALU KIRIM KE BACKEND, bahkan jika offline
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(productData)
        });
        
        const result = await response.json();
        console.log('üì• Add product response:', result);
        
        if (result.success) {
            const source = result.source || 'unknown';
            const message = source === 'mongodb' 
                ? '‚úÖ Produk berhasil ditambahkan ke MongoDB!' 
                : '‚úÖ Produk berhasil ditambahkan ke sistem!';
            
            showNotification(message, false);
            document.getElementById('addProductForm').reset();
            
            // Reload products dari backend untuk mendapatkan data terbaru
            await loadProducts();
            loadAdminProducts();
        } else {
            throw new Error(result.error || 'Gagal menambah produk');
        }
    } catch (error) {
        console.error('‚ùå Error adding product:', error);
        showNotification(`‚ùå Gagal menambah produk: ${error.message}`, true);
    }
}

// Hapus produk - SELALU GUNAKAN BACKEND
async function deleteProduct(productId, showNotificationFlag = true) {
    if (!confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
        return;
    }
    
    try {
        console.log('üóëÔ∏è Deleting product from backend:', productId);
        
        const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (showNotificationFlag) {
                showNotification('‚úÖ Produk berhasil dihapus!', false);
            }
            // Reload dari backend untuk sync data
            await loadProducts();
            loadAdminProducts();
        } else {
            throw new Error(result.error || 'Gagal menghapus produk');
        }
    } catch (error) {
        console.error('‚ùå Error deleting product:', error);
        showNotification(`‚ùå Gagal menghapus produk: ${error.message}`, true);
    }
}

// Edit produk - GUNAKAN BACKEND
async function editProduct(productId) {
    const product = products.find(p => p._id === productId);
    
    if (!product) {
        showNotification('Produk tidak ditemukan!', true);
        return;
    }
    
    // Isi form dengan data produk
    document.getElementById('productName').value = product.name;
    document.getElementById('productCategory').value = product.category;
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productStock').value = product.stock;
    document.getElementById('productDescription').value = product.description || '';
    
    // Hapus produk lama DARI BACKEND
    await deleteProduct(productId, false);
    
    showNotification('üìù Isi form dengan data baru dan klik "Tambah Produk" untuk menyimpan perubahan', false);
}

// Load produk untuk admin
function loadAdminProducts() {
    const adminProductList = document.getElementById('adminProductList');
    adminProductList.innerHTML = '';
    
    if (products.length === 0) {
        adminProductList.innerHTML = '<div class="loading">Tidak ada produk.</div>';
        return;
    }
    
    products.forEach(product => {
        const productRow = document.createElement('div');
        productRow.className = 'product-row';
        productRow.innerHTML = `
            <div>
                <div class="product-name">${getCategoryEmoji(product.category)} ${product.name}</div>
                <div class="product-price">Rp ${formatCurrency(product.price)} | Stok: ${product.stock} | Kategori: ${getCategoryLabel(product.category)}</div>
                ${product.description ? `<div class="product-stock">${product.description}</div>` : ''}
                <div class="product-stock" style="font-size: 0.8rem; color: #888;">
                    ID: ${product._id}
                </div>
            </div>
            <div class="product-actions-admin">
                <button class="btn btn-warning" onclick="editProduct('${product._id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteProduct('${product._id}')">Hapus</button>
            </div>
        `;
        adminProductList.appendChild(productRow);
    });
}

// =============================================
// FUNGSI ORDER - GUNAKAN BACKEND
// =============================================

// Kirim order ke backend
async function sendOrderToBackend(orderData) {
    try {
        console.log('üì§ Sending order to backend:', orderData);
        
        const response = await fetch(`${API_BASE_URL}/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        console.log('üì• Order response:', result);
        return result;
    } catch (error) {
        console.error('‚ùå Error sending order:', error);
        return { success: false, error: error.message };
    }
}

// Load orders dari backend
async function loadOrdersFromBackend() {
    try {
        const response = await fetch(`${API_BASE_URL}/orders`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('‚ùå Error loading orders:', error);
        return { success: false, error: error.message };
    }
}

// Update order status
async function updateOrderStatus(orderId, status) {
    try {
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ status })
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('‚ùå Error updating order:', error);
        return { success: false, error: error.message };
    }
}

// =============================================
// FUNGSI UTAMA APLIKASI (TETAP SAMA)
// =============================================

// Tampilkan products
function displayProducts() {
    const productsContainer = document.getElementById('productsContainer');
    productsContainer.innerHTML = '';
    
    const filteredProducts = currentCategory === 'all' 
        ? products 
        : products.filter(product => product.category === currentCategory);
    
    if (filteredProducts.length === 0) {
        productsContainer.innerHTML = '<div class="loading">üòî Tidak ada produk dalam kategori ini</div>';
        return;
    }
    
    filteredProducts.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        
        const stockInfo = product.stock > 0 
            ? `<div class="product-stock" style="color: var(--success);">Stok: ${product.stock}</div>`
            : `<div class="product-stock" style="color: var(--danger);">Stok Habis</div>`;
        
        productCard.innerHTML = `
            <div class="product-image">
                ${getCategoryEmoji(product.category)}
            </div>
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">Rp ${formatCurrency(product.price)}</div>
                ${stockInfo}
                ${product.description ? `<div class="product-stock">${product.description}</div>` : ''}
                <div class="product-actions">
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="decreaseQuantity('${product._id}')">-</button>
                        <input type="text" class="quantity-input" id="quantity-${product._id}" value="0" readonly>
                        <button class="quantity-btn" onclick="increaseQuantity('${product._id}')">+</button>
                    </div>
                    <button class="btn" onclick="addToCart('${product._id}')" ${product.stock === 0 ? 'disabled' : ''}>
                        ${product.stock === 0 ? 'Stok Habis' : 'Tambah'}
                    </button>
                </div>
            </div>
        `;
        productsContainer.appendChild(productCard);
    });
}

// Fungsi helper untuk emoji kategori
function getCategoryEmoji(category) {
    const emojis = {
        'senjata': 'üî´',
        'peluru': 'üì¶',
        'armor': 'ü¶∫',
        'attachment': '‚öôÔ∏è',
        'ganja': 'üåø',
        'meth': 'üíä',
        'alat_rampok': 'üîß'
    };
    return emojis[category] || 'üì¶';
}

// Fungsi helper untuk label kategori
function getCategoryLabel(category) {
    const labels = {
        'senjata': 'Senjata',
        'peluru': 'Peluru',
        'armor': 'Armor',
        'attachment': 'Attachment',
        'ganja': 'Ganja',
        'meth': 'Meth',
        'alat_rampok': 'Alat Rampok'
    };
    return labels[category] || category;
}

// Format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID').format(amount);
}

// ... (Fungsi keranjang dan lainnya tetap sama)

// Notifikasi
function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification' + (isError ? ' error' : '');
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

// =============================================
// INISIALISASI APLIKASI
// =============================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Initializing application...');
    
    // Cek koneksi backend
    await checkBackendConnection();
    
    // Load products
    await loadProducts();
    updateCart();
    
    // Event listeners
    document.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentCategory = button.getAttribute('data-category');
            displayProducts();
        });
    });

    // Event listener untuk form tambah produk - PASTIKAN INI ADA
    document.getElementById('addProductForm').addEventListener('submit', addProduct);

    // ... (Event listeners lainnya tetap sama)
});
